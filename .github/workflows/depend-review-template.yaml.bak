name: "Build For Template"
on:
  workflow_call:
    inputs:
      working-repo:
        required: true
        type: string
      image-name:
        required: true
        type: string
    #secrets:
    #  envPAT:
    #    required: true

jobs:
  dependency-review:
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v3
      - name: Dependency Review
        uses: actions/dependency-review-action@v2
        with:
          # Possible values: "critical", "high", "moderate", "low"
          fail-on-severity: low
          #
          # You can only can only include one of these two options: `allow-licenses` and `deny-licences`
          #
          # Possible values: Any `spdx_id` value(s) from https://docs.github.com/en/rest/licenses
          # allow-licenses: GPL-3.0, BSD-3-Clause, MIT
          #
          # Possible values: Any `spdx_id` value(s) from https://docs.github.com/en/rest/licenses
          # deny-licenses: LGPL-2.0, BSD-2-Clause
  java-build:
    runs-on: ubuntu-latest
    name: "Branch build"
    steps:
        - uses: actions/checkout@v3
        - name: set up JDK 17
          uses: actions/setup-java@v3
          with:
              distribution: 'temurin'
              java-version: 17
              architecture: x64
        - name: Cache Maven packages
          uses: actions/cache@v3.0.2
          with:
              path: ~/.m2
              key: ubuntu-latest-m2-${{ hashFiles('**/pom.xml') }}
              restore-keys: ubuntu-latest-m2-
        - name: Test with Maven
          run: mvn --no-transfer-progress verify
        - name: Log in to the Container registry
          uses: docker/login-action@v1
          with:
            registry: ghcr.io # Using Github container repository
            username: ${{ github.actor }}
            password: ${{ secrets.GITHUB_TOKEN }}  
        - name: Build and push Docker image for server
          uses: docker/build-push-action@v2
          with:
            context: './'
            push: true
            tags: ghcr.io/${{ inputs.working-repo }}/${{ inputs.image-name }}:0.0.${{ github.run_number }}
            #labels: ${{ steps.meta.outputs.labels }}
        